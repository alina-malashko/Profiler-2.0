import React, { useEffect, useRef, useState } from 'react';
import { useField } from 'formik';
import { useSelector } from 'react-redux';
import { selectPhoneCodes } from '@components/fields';
import { findCountryFlagByPhoneCode } from '@utils/findPhoneCodeByCountryId';
import classNames from 'classnames/bind';
import styles from './SelectPhoneNumberCv.module.scss';
import stylesSelect from '../Select.module.scss';

const cx = classNames.bind(styles);
const stylesSelectCx = classNames.bind(stylesSelect);

export const SelectPhoneNumberCv = ({
  name,
  adaptive = true,
  label,
  activeLabel,
  disabled,
  isPhoneNumberTouched,
  setFieldValue,
  onClickPhoneCodesHandler,
  ...props
}) => {
  const phoneCodes = useSelector(selectPhoneCodes);
  const [countryFlag, setCountryFlag] = useState(false);
  const [field, meta, helper] = useField(name);
  const [isVisible, setIsVisible] = useState(false);
  const positionRef = useRef(null);
  const hasError = !!(meta.error && isPhoneNumberTouched);
  const { value } = field;
  const { setValue } = helper;

  useEffect(() => {
    if (value && phoneCodes.length) {
      const countryFlag = findCountryFlagByPhoneCode(phoneCodes, value);
      setCountryFlag(countryFlag);
    }
    if (!value && phoneCodes.length) {
      setValue(phoneCodes[0].code);
      setFieldValue(name + 'Id', phoneCodes[0].id);
      setCountryFlag(phoneCodes[0].country.countryName);
    }
  }, [phoneCodes]);

  useEffect(() => {
    document.addEventListener('click', handleClickOutside);
    return () => document.removeEventListener('click', handleClickOutside);
  }, [phoneCodes]);

  function handleClickOutside(e) {
    const { current } = positionRef;
    if (current && !current.contains(e.target)) {
      setIsVisible(false);
    }
  }

  const onClickListPhoneCodes = (value) => {
    setIsVisible(false);
    setValue(value.code);
    setCountryFlag(value.country.countryName);
    setFieldValue(name + 'Id', value.id);

    if (onClickPhoneCodesHandler) {
      onClickPhoneCodesHandler(name, value.code);
      onClickPhoneCodesHandler(name + 'Id', value.id);
    }
  };

  return (
    <div
      ref={positionRef}
      className={cx(styles.selectPhone, { selectPhone_adaptive: adaptive })}
      style={{ cursor: disabled ? 'no-drop' : 'pointer' }}
    >
      <div className={styles.selectPhone__container}>
        <div
          className={cx(styles.selectPhone__select, { selectPhone__error: hasError })}
          style={{ pointerEvents: disabled ? 'none' : 'auto' }}
          onClick={() => setIsVisible((prev) => !prev)}
        >
          <div className={styles.selectPhone__phoneCode}>
            {countryFlag && (
              <img
                src={require(`../../../../static/images/countryFlags/${countryFlag}.svg`)}
                alt='flag'
              />
            )}
            <span>+{value}</span>
          </div>
          <div
            className={stylesSelectCx({ select__arrowOpen: isVisible, select__arrow: !isVisible })}
          >
            <svg
              width='20'
              height='9'
              viewBox='0 0 20 9'
              fill='none'
              xmlns='http://www.w3.org/2000/svg'
            >
              <path
                d='M9 5.5C9.27614 5.5 9.5 5.72386 9.5 6V9.75C9.5 10.0261 9.27614 10.25 9 10.25C8.72386 10.25 8.5 10.0261 8.5 9.75V6C8.5 5.72386 8.72386 5.5 9 5.5Z'
                fill='#D40000'
              />
              <path
                d='M8.99609 11.25C8.58188 11.25 8.24609 11.5858 8.24609 12C8.24609 12.4142 8.58188 12.75 8.99609 12.75H9.00283C9.41704 12.75 9.75283 12.4142 9.75283 12C9.75283 11.5858 9.41704 11.25 9.00283 11.25H8.99609Z'
                fill='#D40000'
              />
              <path
                fillRule='evenodd'
                clipRule='evenodd'
                d='M0.433594 0.508411C0.705097 0.195587 1.17879 0.16209 1.49161 0.433594L8.9007 6.86403C9.49367 7.37867 10.5063 7.37867 11.0993 6.86403L18.5084 0.433594C18.8212 0.16209 19.2949 0.195587 19.5664 0.508411C19.8379 0.821235 19.8044 1.29493 19.4916 1.56643L12.0825 7.99686C10.9255 9.00106 9.07453 9.00106 7.9175 7.99686L0.508411 1.56643C0.195587 1.29493 0.16209 0.821235 0.433594 0.508411Z'
                fill='#407BFF'
              />
            </svg>
          </div>
        </div>
        <div className={styles.selectPhone__input}>{props.children}</div>
      </div>
      {!isVisible && hasError && (
        <div
          className={cx(styles.error, { error_adaptive: adaptive, error_notAdaptive: !adaptive })}
        >
          <svg
            width='18'
            height='18'
            viewBox='0 0 18 18'
            fill='none'
            xmlns='http://www.w3.org/2000/svg'
          >
            <path
              d='M9 5.5C9.27614 5.5 9.5 5.72386 9.5 6V9.75C9.5 10.0261 9.27614 10.25 9 10.25C8.72386 10.25 8.5 10.0261 8.5 9.75V6C8.5 5.72386 8.72386 5.5 9 5.5Z'
              fill='#D40000'
            />
            <path
              d='M8.99609 11.25C8.58188 11.25 8.24609 11.5858 8.24609 12C8.24609 12.4142 8.58188 12.75 8.99609 12.75H9.00283C9.41704 12.75 9.75283 12.4142 9.75283 12C9.75283 11.5858 9.41704 11.25 9.00283 11.25H8.99609Z'
              fill='#D40000'
            />
            <path
              fillRule='evenodd'
              clipRule='evenodd'
              d='M1 9C1 4.59886 4.59886 1 9 1C13.4011 1 17 4.59886 17 9C17 13.4011 13.4011 17 9 17C4.59886 17 1 13.4011 1 9ZM9 2C5.15114 2 2 5.15114 2 9C2 12.8489 5.15114 16 9 16C12.8489 16 16 12.8489 16 9C16 5.15114 12.8489 2 9 2Z'
              fill='#D40000'
            />
          </svg>
          {meta.error}
        </div>
      )}
      {isVisible && phoneCodes.length >= 1 && (
        <div
          className={cx(styles.selectPhone__dropdown, {
            selectPhone__dropdown_adaptive: adaptive,
            selectPhone__dropdown_notAdaptive: !adaptive
          })}
        >
          <div className={styles.selectPhone__title}>Country</div>
          {phoneCodes.map((phoneCode, index) => (
            <React.Fragment key={phoneCode.id}>
              <div
                className={cx(styles.selectPhone__item, {
                  selectPhone__item_active: phoneCode.code === value
                })}
                onClick={() => onClickListPhoneCodes(phoneCode)}
              >
                <div className={styles.selectPhone__countryName}>
                  <img
                    src={require(`../../../../static/images/countryFlags/${phoneCode.country.countryName}.svg`)}
                    alt='flag'
                  />
                  {phoneCode.country.countryName}
                </div>
                <div className={styles.selectPhone__countryCode}>+{phoneCode.code}</div>
              </div>
              {index === 4 && <div className={styles.selectPhone__line}></div>}
            </React.Fragment>
          ))}
        </div>
      )}
    </div>
  );
};
